<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broadcast GUI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input, .form-group textarea, .form-group button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<h1>Broadcast GUI</h1>

<h2>Users</h2>
<table id="users-table">
    <thead>
    <tr>
        <th>Telegram ID</th>
        <th>Blocked</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Create Broadcast</h2>
<div class="form-group">
    <label for="message">Message:</label>
    <textarea id="message" rows="4"></textarea>
</div>
<div class="form-group">
    <label for="users">Users (Optional) : List of telegram user ids seperated by comma</label>
    <textarea id="users" rows="4"></textarea>
</div>
<div class="form-group">
    <button id="create-broadcast">Create Broadcast</button>
</div>

<h2>Broadcasts</h2>
<table id="broadcasts-table">
    <thead>
    <tr>
        <th>ID</th>
        <th>Message</th>
        <th>Status</th>
        <th>Total Users</th>
        <th>Successful</th>
        <th>Failed</th>
        <th>Created At</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    const API_BASE_URL = 'http://127.0.0.1:8000/api'; // Replace with your Django API base URL

    // Fetch and display users
    async function fetchUsers() {
        try {
            const response = await fetch(`${API_BASE_URL}/users/`);
            const users = await response.json();

            const usersTableBody = document.querySelector('#users-table tbody');
            usersTableBody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                        <td>${user.telegram_id}</td>
                        <td>${user.blocked ? 'Yes' : 'No'}</td>
                    `;
                usersTableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching users:', error);
        }
    }

    // Fetch and display broadcasts
    async function fetchBroadcasts() {
        try {
            const response = await fetch(`${API_BASE_URL}/broadcast/?ordering=-created_at`);
            const broadcasts = await response.json();

            const broadcastsTableBody = document.querySelector('#broadcasts-table tbody');
            broadcastsTableBody.innerHTML = '';

            broadcasts.forEach(broadcast => {
                const row = document.createElement('tr');
                row.innerHTML = `
                        <td>${broadcast.id}</td>
                        <td>${broadcast.message}</td>
                        <td>${broadcast.status}</td>
                        <td>${broadcast.total_target_users}</td>
                        <td>${broadcast.total_successful}</td>
                        <td>${broadcast.total_failed}</td>
                        <td>${new Date(broadcast.created_at).toLocaleString()}</td>
                    `;
                broadcastsTableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching broadcasts:', error);
        }
    }

    // Create a new broadcast
    async function createBroadcast() {
        const message = document.getElementById('message').value;
        const users = document.getElementById('users').value;
        let user_list = null;

        if (!message) {
            alert('Message cannot be empty.');
            return;
        }

        if (users) {
            user_list = users.split(',')
        }

        try {
            const response = await fetch(`${API_BASE_URL}/broadcast/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({'message': message, 'users': user_list}),
            });

            if (response.ok) {
                alert('Broadcast created successfully!');
                document.getElementById('message').value = '';
                fetchBroadcasts(); // Refresh the broadcasts list
            } else {
                alert('Error creating broadcast.');
            }
        } catch (error) {
            console.error('Error creating broadcast:', error);
        }
    }

    // Event listener for create broadcast button
    document.getElementById('create-broadcast').addEventListener('click', createBroadcast);

    // Initial data fetch
    fetchUsers();
    fetchBroadcasts();
</script>
</body>
</html>
